# name: test/sql/partitioning/disable_hive_partitioning.test
# description: Test option to disable subfolder creation for partitioning
# group: [partitioning]

require ducklake

require parquet

# partitioning based on a column
test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_partition_use_hive', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

statement ok
CREATE TABLE partitioned_tbl(part_key INTEGER, values VARCHAR);

statement ok
CREATE TABLE hiveless_partitioned_tbl(part_key INTEGER, values VARCHAR);

statement ok
CALL ducklake.set_option('hive_file_pattern', False, table_name => 'hiveless_partitioned_tbl')

statement ok
ALTER TABLE partitioned_tbl SET PARTITIONED BY (part_key);

statement ok
INSERT INTO partitioned_tbl SELECT i%2, concat('thisisastring_', i) FROM range(5) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# This is partitioned
query IIII
FROM '${DATA_PATH}/ducklake_partition_use_hive/main/partitioned_tbl/part_key=0/*.parquet'
----
0	thisisastring_0	0	4
0	thisisastring_2	2	4
0	thisisastring_4	4	4

statement ok
ALTER TABLE hiveless_partitioned_tbl SET PARTITIONED BY (part_key);

# Insert more than 10 rows to bypass inlining (direct file write respects hive_file_pattern=False)
statement ok
INSERT INTO hiveless_partitioned_tbl SELECT i%2, concat('thisisastring_', i) FROM range(20) t(i)

statement error
FROM '${DATA_PATH}/ducklake_partition_use_hive/main/hiveless_partitioned_tbl/part_key=0/*.parquet'
----
No files found that match the pattern

statement ok
CALL ducklake.set_option('hive_file_pattern', False, table_name => 'partitioned_tbl')


# What if we now insert more data into our partitioned table
# Insert more than 10 rows to bypass inlining (direct file write respects hive_file_pattern=False)
statement ok
INSERT INTO partitioned_tbl SELECT i%2, concat('thisisastring_', i) FROM range(20) t(i)

# Data remains the same (only original 5 rows in hive-style files, with internal columns from flush)
query IIII
FROM '${DATA_PATH}/ducklake_partition_use_hive/main/partitioned_tbl/part_key=0/*.parquet'
----
0	thisisastring_0	0	4
0	thisisastring_2	2	4
0	thisisastring_4	4	4

# But we can query all data normally (original 5 + new 20 = 25 rows, 13 with part_key=0)
query II
FROM partitioned_tbl where part_key = 0
----
0	thisisastring_0
0	thisisastring_2
0	thisisastring_4
0	thisisastring_0
0	thisisastring_2
0	thisisastring_4
0	thisisastring_6
0	thisisastring_8
0	thisisastring_10
0	thisisastring_12
0	thisisastring_14
0	thisisastring_16
0	thisisastring_18