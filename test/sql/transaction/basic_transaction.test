# name: test/sql/transaction/basic_transaction.test
# description: Test basic transaction support of ducklakes
# group: [transaction]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


# Disable inlining - this test needs physical files to verify transaction rollback cleanup
statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_tl_files', METADATA_CATALOG 'ducklake_meta')

statement ok
USE ducklake

# table creation
statement ok
BEGIN

statement ok
CREATE TABLE test(i INTEGER, j INTEGER);

# we can query the table
query II
SELECT * FROM test
----

query I
SHOW TABLES
----
test


statement ok
ROLLBACK

# after rollback the table no longer exists
statement error
SELECT * FROM test
----
does not exist

query I
SHOW TABLES
----

# create the table again
statement ok
CREATE TABLE test(i INTEGER, j INTEGER);

# we can query transaction local data
statement ok
BEGIN

# Insert more than DATA_INLINING_ROW_LIMIT (10) rows so flush creates a parquet file
statement ok
INSERT INTO test SELECT i, i*2 FROM range(20) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

query II
SELECT * FROM test LIMIT 3
----
0	0
1	2
2	4

# the data exists as files in the data directory
query I
SELECT COUNT(*) FROM glob('${DATA_PATH}/ducklake_tl_files/**/*.parquet')
----
1

statement ok
ROLLBACK

# rolling back deletes the rows from the table
query I
SELECT COUNT(*) FROM test
----
0

# it also deletes the written files from the data directory
query I
SELECT COUNT(*) FROM glob('${DATA_PATH}/ducklake_tl_files/**/*.parquet')
----
0
