# name: test/sql/sorted_table/merge_adjacent_sorted_renamed.test
# description: ensure that setting identical sort orders does not create extra catalog entries
# group: [sorted_table]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db



statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '__TEST_DIR__/merge_adjacent_options_sorted/')

statement ok
USE ducklake;

# SET SORTED BY then rename columns - compaction should error on missing columns
statement ok
CREATE TABLE renamed_columns_test (unique_id BIGINT, sort_key_1 BIGINT, sort_key_2 VARCHAR);

statement ok
ALTER TABLE ducklake.renamed_columns_test SET SORTED BY (sort_key_1 ASC NULLS LAST, sort_key_2 ASC NULLS LAST);

# Rename the sort columns to completely different names
statement ok
ALTER TABLE renamed_columns_test RENAME COLUMN sort_key_1 TO sort_key_1_changed;

statement ok
ALTER TABLE renamed_columns_test RENAME COLUMN sort_key_2 TO sort_key_2_changed;

# Insert data twice to create two files
statement ok
INSERT INTO renamed_columns_test (unique_id, sort_key_1_changed, sort_key_2_changed)
FROM range(4) t(i)
SELECT
    i AS unique_id,
    i % 2 AS sort_key_1_changed,
    'woot' || i AS sort_key_2_changed
ORDER BY
    i DESC
;

statement ok
INSERT INTO renamed_columns_test (unique_id, sort_key_1_changed, sort_key_2_changed)
FROM range(4) t(i)
SELECT
    i + 4 AS unique_id,
    (i + 4) % 2 AS sort_key_1_changed,
    'woot' || (i + 4) AS sort_key_2_changed
ORDER BY
    i DESC
;

# Flush fails because of the renamed columns - SORTED BY references old column names
# (With inlining, the error now happens at flush time instead of at merge_adjacent_files time)
statement error
CALL ducklake_flush_inlined_data('ducklake')
----
Binder Error: Columns in the SET SORTED BY statement were not found in the DuckLake table. Unmatched columns were: sort_key_1, sort_key_2

# Fix the SORTED BY settings to use new column names
statement ok
ALTER TABLE ducklake.renamed_columns_test SET SORTED BY (sort_key_1_changed ASC NULLS LAST, sort_key_2_changed ASC NULLS LAST);

# Now flush should work
statement ok
CALL ducklake_flush_inlined_data('ducklake')

# Compaction should also work now
statement ok
CALL ducklake_merge_adjacent_files('ducklake', 'renamed_columns_test');