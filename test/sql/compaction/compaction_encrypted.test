# name: test/sql/compaction/compaction_encrypted.test
# description: test compaction on an encrypted database
# group: [compaction]

require ducklake

require parquet

require httpfs

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_compaction_encrypted_files', ENCRYPTED)

statement ok
CREATE TABLE ducklake.test(i INTEGER);

statement ok
INSERT INTO ducklake.test VALUES (1);

statement ok
CALL ducklake_flush_inlined_data('ducklake');

statement ok
INSERT INTO ducklake.test VALUES (2);

statement ok
CALL ducklake_flush_inlined_data('ducklake');

statement ok
INSERT INTO ducklake.test VALUES (3);

statement ok
CALL ducklake_flush_inlined_data('ducklake');

query III
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	3	1

# delete the old files
statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

# all files have been compacted into one file
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_compaction_encrypted_files/**/*')
----
1

# verify the file is encrypted
statement error
SELECT * FROM '${DATA_PATH}/ducklake_compaction_encrypted_files/**/*.parquet'
----
encrypted

# all reading still works
query I
SELECT * FROM ducklake.test AT (VERSION => 2)
----
1

query II
SELECT rowid, * FROM ducklake.test ORDER BY ALL
----
0	1
1	2
2	3
