# name: test/sql/compaction/compaction_delete_conflict.test
# description: Test transaction conflicts with compaction
# group: [compaction]

require ducklake

require parquet


test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_conflicts_compaction_files')

statement ok
SET immediate_transaction_mode=true

statement ok
CREATE TABLE ducklake.test(i INTEGER);

# Insert more than 10 rows per insert so flush creates files
statement ok
INSERT INTO ducklake.test SELECT * FROM range(1, 12);

statement ok
INSERT INTO ducklake.test SELECT * FROM range(12, 23);

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# try to commit a delete after a compaction: conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

query III con1
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	2	1

statement ok con2
DELETE FROM ducklake.test

statement ok con1
COMMIT

statement error con2
COMMIT
----


statement ok
INSERT INTO ducklake.test SELECT * FROM range(23, 34);

statement ok
INSERT INTO ducklake.test SELECT * FROM range(34, 45);

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# try to commit a compaction after a deletion: conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

statement ok con1
DELETE FROM ducklake.test

query III con2
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	3	1

statement ok con1
COMMIT

statement error con2
COMMIT
----


statement ok
INSERT INTO ducklake.test SELECT * FROM range(45, 56);

statement ok
INSERT INTO ducklake.test SELECT * FROM range(56, 67);

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# two transactions both try to compact: conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

query III con1
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	2	1

query III con2
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	2	1

statement ok con1
COMMIT

statement error con2
COMMIT
----


statement ok
INSERT INTO ducklake.test SELECT * FROM range(67, 78);

statement ok
INSERT INTO ducklake.test SELECT * FROM range(78, 89);

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# compaction and insert: no conflict
statement ok con1
BEGIN

statement ok con2
BEGIN

query III con1
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----
test	3	1

statement ok con2
INSERT INTO ducklake.test SELECT * FROM range(89, 100);

statement ok con1
COMMIT

statement ok con2
COMMIT

query I
SELECT * FROM ducklake.test ORDER BY ALL
----
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
