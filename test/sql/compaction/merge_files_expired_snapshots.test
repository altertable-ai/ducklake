# name: test/sql/compaction/merge_files_expired_snapshots.test
# description: test ducklake merges files from expired snapshots if they also belong to current snapshot
# group: [compaction]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_merge_expire_snapshots_schema')

statement ok
USE ducklake;

statement ok
CREATE TABLE example (key VARCHAR, value VARCHAR);

# With 15 rows, files are created directly
statement ok
INSERT INTO example SELECT 'foo' || i, 'bar' || i FROM range(15) t(i);

statement ok
INSERT INTO example SELECT 'baz' || i, 'qux' || i FROM range(15) t(i);

query II
SELECT snapshot_id, changes FROM snapshots();
----
0	{schemas_created=[main]}
1	{tables_created=[main.example]}
2	{tables_inserted_into=[1]}
3	{tables_inserted_into=[1]}

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
2

statement ok
CALL ducklake_expire_snapshots('ducklake', versions => [1,2]);

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
2

statement ok
CALL ducklake.merge_adjacent_files();

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
1

query II
FROM example ORDER BY key LIMIT 4
----
baz0	qux0
baz1	qux1
baz10	qux10
baz11	qux11

# Add a few schema changes
statement ok
INSERT INTO example SELECT 'a' || i, 'b' || i FROM range(15) t(i);

statement ok
ALTER TABLE example ADD COLUMN j INTEGER

statement ok
INSERT INTO example SELECT 'c' || i, 'd' || i, i FROM range(15) t(i);

statement ok
INSERT INTO example SELECT 'e' || i, 'f' || i, i+15 FROM range(15) t(i);

statement ok
ALTER TABLE example DROP COLUMN key

statement ok
INSERT INTO example SELECT 'k' || i, i+30 FROM range(15) t(i);

statement ok
INSERT INTO example SELECT 'ff' || i, i+45 FROM range(15) t(i);

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
6

query II
SELECT snapshot_id, changes FROM snapshots();
----
0	{schemas_created=[main]}
3	{tables_inserted_into=[1]}
4	{merge_adjacent=[1]}
5	{tables_inserted_into=[1]}
6	{tables_altered=[1]}
7	{tables_inserted_into=[1]}
8	{tables_inserted_into=[1]}
9	{tables_altered=[1]}
10	{tables_inserted_into=[1]}
11	{tables_inserted_into=[1]}


statement ok
CALL ducklake_expire_snapshots('ducklake', versions => [5,6,7,8,9,10]);

query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
6

statement ok
CALL ducklake.merge_adjacent_files();

# We altered the schema twice, hence we can have 3 files, as there are only 3 different schemas.
query I
SELECT count(*) FROM ducklake_list_files('ducklake', 'example');
----
3

query II
FROM example ORDER BY ALL LIMIT 10
----
b0	NULL
b1	NULL
b10	NULL
b11	NULL
b12	NULL
b13	NULL
b14	NULL
b2	NULL
b3	NULL
b4	NULL