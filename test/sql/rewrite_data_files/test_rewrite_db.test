# name: test/sql/rewrite_data_files/test_rewrite_db.test
# description: Test calling the delete rewrite function multiple times, over a series of deletes, test the threshold parameter behaves well
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/rewrite_db', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

# Lets create multiple tables, and do insertions and deletions
loop i 0 2

statement ok
CREATE TABLE test_${i} (key INTEGER, values VARCHAR);

statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# Let's do a few insertions interleaved with deletions
statement ok
DELETE FROM test_${i}
WHERE key < 50;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100,200) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test_${i}
WHERE key < 80;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test_${i}
WHERE key  = 120;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

endloop

# Check ze files before rewrite
query IIII
SELECT data_file_id, delete_file_id, begin_snapshot, end_snapshot FROM ducklake_metadata.ducklake_delete_file
----
0	3	3	NULL
2	4	6	NULL
5	8	10	NULL
7	9	13	NULL

query III
SELECT data_file_id, begin_snapshot, end_snapshot FROM ducklake_metadata.ducklake_data_file
----
0	2	NULL
2	4	NULL
5	9	NULL
7	11	NULL

# Now lets call the rewrite function in the whole DB
query III
SELECT table_name, files_processed, files_created FROM ducklake_rewrite_data_files('ducklake', delete_threshold => 0) ORDER BY ALL
----
test_0	2	1
test_1	2	1

# Check ze files after rewrite, we should have removed the last file of each table
query IIII
SELECT data_file_id, delete_file_id, begin_snapshot, end_snapshot FROM ducklake_metadata.ducklake_delete_file ORDER BY ALL
----
0	3	3	15
2	4	6	15
5	8	10	15
7	9	13	15

query III
SELECT data_file_id, begin_snapshot, end_snapshot FROM ducklake_metadata.ducklake_data_file  ORDER BY ALL
----
0	2	15
2	4	15
5	9	15
7	11	15
10	15	NULL
11	15	NULL

# Validate some results
query I
select count(*) from test_0 AT (VERSION => 2);
----
100

query I
select count(*) from test_0 AT (VERSION => 3);
----
50

query I
select count(*) from test_0 AT (VERSION => 4);
----
150

query I
select count(*) from test_0 AT (VERSION => 5);
----
120

query I
select count(*) from test_0 AT (VERSION => 6);
----
119

query I
select count(*) from test_0 AT (VERSION => 7);
----
119

# Check other table
query I
select count(*) from test_1 AT (VERSION => 9);
----
100

query I
select count(*) from test_1 AT (VERSION => 10);
----
50

query I
select count(*) from test_1 AT (VERSION => 11);
----
150

query I
select count(*) from test_1 AT (VERSION => 12);
----
120

query I
select count(*) from test_1 AT (VERSION => 13);
----
119

query I
select count(*) from test_1 AT (VERSION => 14);
----
119

query I
select count(*) from test_0;
----
119

query I
select count(*) from test_1;
----
119