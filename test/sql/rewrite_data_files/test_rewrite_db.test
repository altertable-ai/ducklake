# name: test/sql/rewrite_data_files/test_rewrite_db.test
# description: Test calling the delete rewrite function multiple times, over a series of deletes, test the threshold parameter behaves well
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/rewrite_db', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

# Lets create multiple tables, and do insertions and deletions
loop i 0 2

statement ok
CREATE TABLE test_${i} (key INTEGER, values VARCHAR);

statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# Let's do a few insertions interleaved with deletions
statement ok
DELETE FROM test_${i}
WHERE key < 50;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
INSERT INTO test_${i}  SELECT i, concat('thisisastring_', i) FROM range(100,200) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test_${i}
WHERE key < 80;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test_${i}
WHERE key  = 120;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

endloop

# Capture the snapshot before rewrite (last snapshot_id)
statement ok
SET VARIABLE pre_rewrite_snap = (SELECT max(snapshot_id) FROM ducklake_snapshots('ducklake'))

# Check ze files before rewrite - verify counts and structural properties
# The exact begin_snapshot values differ between inline and no-inline modes
query I
SELECT count(*) FROM ducklake_metadata.ducklake_delete_file WHERE end_snapshot IS NULL
----
4

query I
SELECT count(*) FROM ducklake_metadata.ducklake_data_file WHERE end_snapshot IS NULL
----
4

# Now lets call the rewrite function in the whole DB
query III
SELECT table_name, files_processed, files_created FROM ducklake_rewrite_data_files('ducklake', delete_threshold => 0) ORDER BY ALL
----
test_0	2	1
test_1	2	1

# Capture the rewrite snapshot id
statement ok
SET VARIABLE rewrite_snap = (SELECT max(snapshot_id) FROM ducklake_snapshots('ducklake'))

# Check ze files after rewrite, we should have removed the last file of each table
# All old delete files should now have end_snapshot = rewrite_snap
query I
SELECT count(*) FROM ducklake_metadata.ducklake_delete_file WHERE end_snapshot = getvariable('rewrite_snap')
----
4

query I
SELECT count(*) FROM ducklake_metadata.ducklake_delete_file WHERE end_snapshot IS NULL
----
0

# All old data files should have end_snapshot = rewrite_snap, plus 2 new ones with end_snapshot IS NULL
query I
SELECT count(*) FROM ducklake_metadata.ducklake_data_file WHERE end_snapshot = getvariable('rewrite_snap')
----
4

query I
SELECT count(*) FROM ducklake_metadata.ducklake_data_file WHERE end_snapshot IS NULL
----
2

query I
SELECT count(*) FROM ducklake_metadata.ducklake_data_file WHERE begin_snapshot = getvariable('rewrite_snap') AND end_snapshot IS NULL
----
2

# Validate time travel results for test_0
# Capture snapshot IDs for test_0 operations (table_id=1)
# test_0 insert 1
statement ok
SET VARIABLE t0_insert1 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%insert%=[1]%')

# test_0 delete 1 (first delete snapshot for table 1)
statement ok
SET VARIABLE t0_del1 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[1]%')

# test_0 insert 2 (second insert for table 1)
statement ok
SET VARIABLE t0_insert2 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%insert%=[1]%' AND snapshot_id > getvariable('t0_del1'))

# test_0 delete 2 (second delete for table 1, after second insert)
statement ok
SET VARIABLE t0_del2 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[1]%' AND snapshot_id > getvariable('t0_insert2'))

# test_0 last delete snapshot (last delete-related snapshot for table 1)
statement ok
SET VARIABLE t0_del3 = (SELECT max(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[1]%' OR changes::VARCHAR LIKE '%inlined_delete=[1]%')

# After first insert: 100 rows
query I
select count(*) from test_0 AT (VERSION => getvariable('t0_insert1'));
----
100

# After first delete (key < 50): 50 rows
query I
select count(*) from test_0 AT (VERSION => getvariable('t0_del1'));
----
50

# After second insert: 150 rows
query I
select count(*) from test_0 AT (VERSION => getvariable('t0_insert2'));
----
150

# After second delete (key < 80): 120 rows
query I
select count(*) from test_0 AT (VERSION => getvariable('t0_del2'));
----
120

# After last delete (key = 120): 119 rows
# In inline mode this is a flushed_inlined snapshot; in no-inline it's a tables_deleted_from
query I
select count(*) from test_0 AT (VERSION => getvariable('t0_del3'));
----
119

# Validate time travel results for test_1
# Capture snapshot IDs for test_1 operations (table_id=2)
# test_1 insert 1
statement ok
SET VARIABLE t1_insert1 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%insert%=[2]%')

# test_1 delete 1
statement ok
SET VARIABLE t1_del1 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[2]%')

# test_1 insert 2
statement ok
SET VARIABLE t1_insert2 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%insert%=[2]%' AND snapshot_id > getvariable('t1_del1'))

# test_1 delete 2
statement ok
SET VARIABLE t1_del2 = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[2]%' AND snapshot_id > getvariable('t1_insert2'))

# test_1 last delete snapshot
statement ok
SET VARIABLE t1_del3 = (SELECT max(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[2]%' OR changes::VARCHAR LIKE '%inlined_delete=[2]%')

# After first insert: 100 rows
query I
select count(*) from test_1 AT (VERSION => getvariable('t1_insert1'));
----
100

# After first delete (key < 50): 50 rows
query I
select count(*) from test_1 AT (VERSION => getvariable('t1_del1'));
----
50

# After second insert: 150 rows
query I
select count(*) from test_1 AT (VERSION => getvariable('t1_insert2'));
----
150

# After second delete (key < 80): 120 rows
query I
select count(*) from test_1 AT (VERSION => getvariable('t1_del2'));
----
120

# After last delete (key = 120): 119 rows
query I
select count(*) from test_1 AT (VERSION => getvariable('t1_del3'));
----
119

# Check current state
query I
select count(*) from test_0;
----
119

query I
select count(*) from test_1;
----
119
