# name: test/sql/rewrite_data_files/test_last_snapshot_merge_rewrite.test
# description: Test deletion works in combination with merge
# group: [rewrite_data_files]

require ducklake

require parquet

test-env DUCKLAKE_CONNECTION __TEST_DIR__/{UUID}.db

test-env DATA_PATH __TEST_DIR__


statement ok
ATTACH 'ducklake:${DUCKLAKE_CONNECTION}' AS ducklake (DATA_PATH '${DATA_PATH}/ducklake_last_merge_rewrite', METADATA_CATALOG 'ducklake_metadata')

statement ok
USE ducklake

loop i 0 2

statement ok
CREATE TABLE test(key INTEGER, values VARCHAR);

statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(100) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

# Let's do a few insertions interleaved with deletions
statement ok
DELETE FROM test
WHERE key < 50;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(100,200) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test
WHERE key < 80;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test
WHERE key  = 120;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
INSERT INTO test SELECT i, concat('thisisastring_', i) FROM range(200,300) t(i)

statement ok
CALL ducklake_flush_inlined_data('ducklake')

statement ok
DELETE FROM test
WHERE key  > 200 and key < 250;

statement ok
CALL ducklake_flush_inlined_data('ducklake')

skipif i=1
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
7

skipif i=0
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
14


skipif i=0
query III
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----

skipif i=1
query III
SELECT table_name, files_processed, files_created FROM ducklake_rewrite_data_files('ducklake', 'test', delete_threshold => 0) ORDER BY ALL
----
test	3	1

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

skipif i=0
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
13

skipif i=1
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
7

skipif i=0
query III
SELECT table_name, files_processed, files_created FROM ducklake_rewrite_data_files('ducklake', 'test', delete_threshold => 0) ORDER BY ALL
----
test	3	1

skipif i=1
query III
SELECT table_name, files_processed, files_created FROM ducklake_merge_adjacent_files('ducklake')
----

skipif i=0
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
14

skipif i=1
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
7

statement ok
CALL ducklake_cleanup_old_files('ducklake', cleanup_all => true);

skipif i=1
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
7

skipif i=0
query I
SELECT COUNT(*) FROM GLOB('${DATA_PATH}/ducklake_last_merge_rewrite/**/*')
----
14

query I
select count(*) from test;
----
170

query I
select count(*) from test AT (VERSION => 2);
----
100

query I
select count(*) from test AT (VERSION => 3);
----
50

query I
select count(*) from test AT (VERSION => 4);
----
150

query I
select count(*) from test AT (VERSION => 5);
----
120

query I
select count(*) from test AT (VERSION => 6);
----
119

# compute snapshot IDs dynamically so the test works in both inline and no-inline modes
# s_ins3 = the 3rd INSERT snapshot (INSERT 200-299, count=219)
statement ok
SET VARIABLE s_ins3 = (SELECT snapshot_id FROM (SELECT snapshot_id, row_number() OVER (ORDER BY snapshot_id) AS rn FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%insert%=[1]%') WHERE rn = 3);

# s_del_last = the first DELETE snapshot after s_ins3 that is not a rewrite (DELETE >200 AND <250, count=170)
statement ok
SET VARIABLE s_del_last = (SELECT min(snapshot_id) FROM ducklake_snapshots('ducklake') WHERE changes::VARCHAR LIKE '%delete%=[1]%' AND changes::VARCHAR NOT LIKE '%rewrite%' AND snapshot_id > getvariable('s_ins3'));

query I
select count(*) from test AT (VERSION => getvariable('s_ins3'));
----
219

query I
select count(*) from test AT (VERSION => getvariable('s_del_last'));
----
170

statement ok
drop table test;

endloop